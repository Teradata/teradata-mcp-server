---
phase: 05-ruff-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/teradata_mcp_server/tools/tdvs/__init__.py
  - src/teradata_mcp_server/app.py
  - src/teradata_mcp_server/middleware.py
  - src/teradata_mcp_server/auth_cache.py
  - src/teradata_mcp_server/auth_validation.py
  - src/teradata_mcp_server/tools/bar/bar_tools.py
  - src/teradata_mcp_server/tools/base/base_tools.py
  - src/teradata_mcp_server/tools/chat/chat_tools.py
  - src/teradata_mcp_server/tools/fs/fs_tools.py
  - src/teradata_mcp_server/tools/rag/rag_tools.py
  - src/teradata_mcp_server/tools/sql_opt/sql_opt_tools.py
  - src/teradata_mcp_server/tools/tdvs/tdvs_tools.py
  - src/teradata_mcp_server/tools/tdvs/tdvs_utilies.py
  - src/teradata_mcp_server/tools/utils/__init__.py
autonomous: true

must_haves:
  truths:
    - "tdvs/__init__.py has __all__ listing all 15 re-exported symbols"
    - "All 21 truly unused imports are removed from their respective source files"
    - "3 side-effect imports in app.py have # noqa: F401 annotations"
    - "utils/__init__.py unused Optional import is removed"
    - "No functional behavior has changed -- only unused imports removed and noqa annotations added"
  artifacts:
    - path: "src/teradata_mcp_server/tools/tdvs/__init__.py"
      provides: "__all__ for tdvs re-exports"
      contains: "__all__"
    - path: "src/teradata_mcp_server/app.py"
      provides: "noqa annotations on 3 side-effect imports"
      contains: "noqa: F401"
  key_links:
    - from: "src/teradata_mcp_server/tools/tdvs/__init__.py"
      to: "src/teradata_mcp_server/tools/tdvs/tdvs_tools.py"
      via: "explicit imports of 10 handlers"
      pattern: "from \\.tdvs_tools import"
---

<objective>
Fix all 24 F401 violations currently hidden by global ruff suppression, and add `__all__` to `tdvs/__init__.py`. This prepares the codebase so suppressions can be safely removed in Plan 02.

Purpose: The global F401/F403 suppression cannot be removed until all existing violations are resolved. This plan resolves every one: 21 truly unused imports are removed, 3 intentional side-effect imports get `# noqa: F401`, and tdvs gets its missing `__all__`.

Output: Zero F401 violations when checked with `ruff check --select F401` (excluding tests/). All handler discovery unchanged.
</objective>

<execution_context>
@/Users/Daniel.Tehan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Daniel.Tehan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ruff-enforcement/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add __all__ to tdvs/__init__.py and fix all 24 F401 violations across the codebase</name>
  <files>
    src/teradata_mcp_server/tools/tdvs/__init__.py
    src/teradata_mcp_server/app.py
    src/teradata_mcp_server/middleware.py
    src/teradata_mcp_server/auth_cache.py
    src/teradata_mcp_server/auth_validation.py
    src/teradata_mcp_server/tools/bar/bar_tools.py
    src/teradata_mcp_server/tools/base/base_tools.py
    src/teradata_mcp_server/tools/chat/chat_tools.py
    src/teradata_mcp_server/tools/fs/fs_tools.py
    src/teradata_mcp_server/tools/rag/rag_tools.py
    src/teradata_mcp_server/tools/sql_opt/sql_opt_tools.py
    src/teradata_mcp_server/tools/tdvs/tdvs_tools.py
    src/teradata_mcp_server/tools/tdvs/tdvs_utilies.py
    src/teradata_mcp_server/tools/utils/__init__.py
  </files>
  <action>
This task has two parts executed sequentially.

**Part A: Add `__all__` to `tdvs/__init__.py`**

Append `__all__` after the existing imports in `src/teradata_mcp_server/tools/tdvs/__init__.py`. The file currently has explicit imports but NO `__all__`. Add:

```python
__all__ = [
    "TD_VS_BASE_URL",
    "create_teradataml_context",
    "handle_tdvs_ask",
    "handle_tdvs_create",
    "handle_tdvs_destroy",
    "handle_tdvs_get_details",
    "handle_tdvs_get_health",
    "handle_tdvs_grant_user_permission",
    "handle_tdvs_list",
    "handle_tdvs_revoke_user_permission",
    "handle_tdvs_similarity_search",
    "handle_tdvs_update",
    "VectorStoreAsk",
    "VectorStoreCreate",
    "VectorStoreSimilaritySearch",
    "VectorStoreUpdate",
]
```

This is 16 symbols total (1 constant + 10 handlers + 1 utility + 4 types), alphabetically sorted. All match the existing explicit imports already in the file.

**Part B: Fix 24 F401 violations across 14 files**

Three categories of fixes. Read each file before editing.

**Category 1 -- Side-effect imports (add `# noqa: F401`, do NOT remove):**

These 3 imports in `app.py` look unused to ruff but ARE used at runtime:

1. `app.py` line ~39: `execute_analytic_function` -- used via `exec(func_str, globals())` at line ~535. Add `# noqa: F401` comment with explanation: `# noqa: F401 -- used via exec(func_str, globals())`
2. `app.py` line ~128: `import requests` -- inside `try/except ImportError` availability check for BAR dependencies. Add `# noqa: F401 -- availability check for BAR dependencies`
3. `app.py` line ~130: `from teradata_mcp_server.tools.bar.dsa_client import DSAClient` -- same availability check block. Add `# noqa: F401 -- availability check for BAR dependencies`

**Category 2 -- Truly unused imports (remove the import, NOT the entire line if other names remain):**

4. `app.py`: Remove `BaseModel` from the `from pydantic import ...` import (keep other pydantic imports if any; if BaseModel is the only import on that line, remove the line)
5. `middleware.py`: Remove `import os` (line ~15)
6. `middleware.py`: Remove `Optional` from `from typing import ...` (line ~19; keep other typing imports)
7. `auth_cache.py`: Remove `NamedTuple` and `Optional` from `from typing import ...` (line ~8; keep other typing imports)
8. `auth_validation.py`: Remove `Optional` from `from typing import ...` (line ~11; keep other typing imports)
9. `bar/bar_tools.py`: Remove `import os` (line ~8)
10. `base/base_tools.py`: Remove `import re` (line ~2)
11. `chat/chat_tools.py`: Remove `from pathlib import Path` (line ~9)
12. `chat/chat_tools.py`: Remove `import yaml` (line ~11)
13. `fs/fs_tools.py`: Remove `serialize_teradata_types` from `from ...utils import ...` (line ~16; keep other utils imports)
14. `rag/rag_tools.py`: Remove `from pathlib import Path` (line ~5)
15. `rag/rag_tools.py`: Remove `import yaml` (line ~8)
16. `sql_opt/sql_opt_tools.py`: Remove `import yaml` (line ~11)
17. `sql_opt/sql_opt_tools.py`: Remove `TeradataConnection` from the teradatasqlalchemy import (line ~12; keep other imports from same module)
18. `tdvs/tdvs_tools.py`: Remove `Union` from `from typing import ...` (line ~20; keep other typing imports)
19. `tdvs/tdvs_tools.py`: Remove `import pandas` (line ~22)
20. `tdvs/tdvs_tools.py`: Remove `import requests` (line ~23)
21. `tdvs/tdvs_tools.py`: Remove `remove_context` from `from teradataml import ...` (line ~26; keep other teradataml imports)
22. `tdvs/tdvs_utilies.py`: Remove `Union` from `from typing import ...` (line ~4; keep other typing imports)
23. `tdvs/tdvs_utilies.py`: Remove `import requests` (line ~7)
24. `utils/__init__.py`: Remove `Optional` from `from typing import Any, Optional` (line ~17; keep `Any`)

**IMPORTANT:** For multi-name imports like `from typing import Any, Optional`, only remove the unused name -- do NOT delete the entire import line. For standalone imports like `import os`, remove the entire line.

**Approach:** Use `ruff check --fix --select F401` on each non-`__init__.py` file to auto-fix the 21 truly unused imports (Category 2). Then manually add the 3 `# noqa: F401` annotations (Category 1). Then manually add `__all__` to tdvs (Part A). Ruff autofix will NOT touch `__init__.py` files (they need `__all__`, not removal).

Specifically:

1. First, add `__all__` to `tdvs/__init__.py` (Part A)
2. Then run: `uv run ruff check --fix --select F401 src/teradata_mcp_server/app.py src/teradata_mcp_server/middleware.py src/teradata_mcp_server/auth_cache.py src/teradata_mcp_server/auth_validation.py src/teradata_mcp_server/tools/bar/bar_tools.py src/teradata_mcp_server/tools/base/base_tools.py src/teradata_mcp_server/tools/chat/chat_tools.py src/teradata_mcp_server/tools/fs/fs_tools.py src/teradata_mcp_server/tools/rag/rag_tools.py src/teradata_mcp_server/tools/sql_opt/sql_opt_tools.py src/teradata_mcp_server/tools/tdvs/tdvs_tools.py src/teradata_mcp_server/tools/tdvs/tdvs_utilies.py src/teradata_mcp_server/tools/utils/__init__.py`
   This auto-removes the 21 truly unused imports. Note: ruff autofix for F401 on `utils/__init__.py` will remove `Optional` (the only F401 there) since the existing `# noqa: F401` on line 19 already covers the queryband re-export.
3. After autofix: ruff will also auto-remove `execute_analytic_function`, `requests` (in app.py try block), and `DSAClient` because they look unused. **Re-add these 3 imports manually** with `# noqa: F401` comments:
   - `execute_analytic_function` back into the utils import block in app.py, with: `# noqa: F401 -- used via exec(func_str, globals())`
   - `import requests  # noqa: F401 -- availability check for BAR dependencies` back into the try block
   - `from teradata_mcp_server.tools.bar.dsa_client import DSAClient  # noqa: F401 -- availability check for BAR dependencies` back into the try block

**Alternative approach (safer):** Instead of using ruff autofix on all files at once, manually add `# noqa: F401` to the 3 side-effect imports FIRST, then run ruff autofix. This way ruff will skip the noqa-annotated lines and only remove the truly unused ones.

Use whichever approach produces correct results. The end state must be: zero F401 violations when running `uv run ruff check --select F401` on all modified files (current global/per-file-ignores still active, so this is checking with explicit rule selection).
  </action>
  <verify>
1. Confirm `__all__` exists in tdvs and has 16 entries:
   `uv run python -c "import teradata_mcp_server.tools.tdvs as m; assert hasattr(m, '__all__') and len(m.__all__) == 16, f'tdvs __all__ wrong: {getattr(m, \"__all__\", None)}'; print('tdvs __all__ OK:', len(m.__all__))"`

2. Confirm all 12 tool packages (11 converted + tdvs) have `__all__`:
   `uv run python -c "
import importlib
for pkg in ['tmpl','sec','rag','dba','qlty','chat','base','bar','plot','sql_opt','tdvs']:
    try:
        m = importlib.import_module(f'teradata_mcp_server.tools.{pkg}')
        assert hasattr(m, '__all__'), f'{pkg} missing __all__'
        print(f'  {pkg}: __all__ has {len(m.__all__)} entries')
    except ImportError as e:
        if 'tdfs4ds' in str(e): print(f'  {pkg}: SKIPPED (tdfs4ds not installed)')
        else: raise
print('All packages have __all__')
"`

3. Run ruff F401 check on ALL modified files (override global ignores to actually see violations):
   `uv run ruff check --select F401 --per-file-ignores='tests/*:F401' src/teradata_mcp_server/app.py src/teradata_mcp_server/middleware.py src/teradata_mcp_server/auth_cache.py src/teradata_mcp_server/auth_validation.py src/teradata_mcp_server/tools/bar/bar_tools.py src/teradata_mcp_server/tools/base/base_tools.py src/teradata_mcp_server/tools/chat/chat_tools.py src/teradata_mcp_server/tools/fs/fs_tools.py src/teradata_mcp_server/tools/rag/rag_tools.py src/teradata_mcp_server/tools/sql_opt/sql_opt_tools.py src/teradata_mcp_server/tools/tdvs/tdvs_tools.py src/teradata_mcp_server/tools/tdvs/tdvs_utilies.py src/teradata_mcp_server/tools/utils/__init__.py src/teradata_mcp_server/tools/tdvs/__init__.py`
   This must report zero violations (note: the global ignore in pyproject.toml still hides F401, so we use --select to force checking).

4. Confirm app.py side-effect imports still present:
   `grep -n "noqa: F401" src/teradata_mcp_server/app.py` -- must show 3 lines (execute_analytic_function, requests, DSAClient)

5. Confirm no handler discovery regression -- run the 11-package cross-verification from Phase 4:
   `uv run python -c "
import inspect, importlib
EXPECTED = {
    'tmpl': 1, 'sec': 3, 'rag': 1, 'dba': 6, 'qlty': 7,
    'chat': 2, 'base': 8, 'bar': 6, 'plot': 4, 'sql_opt': 3, 'tdvs': 10,
}
total = 0
for pkg, count in EXPECTED.items():
    try:
        m = importlib.import_module(f'teradata_mcp_server.tools.{pkg}')
        handlers = [n for n, _ in inspect.getmembers(m, inspect.isfunction) if n.startswith('handle_')]
        assert len(handlers) == count, f'{pkg}: expected {count}, got {len(handlers)}'
        total += len(handlers)
        print(f'  {pkg}: {len(handlers)} handlers OK')
    except ImportError as e:
        if 'tdfs4ds' in str(e) and pkg == 'fs':
            total += count
            print(f'  {pkg}: SKIPPED')
        else: raise
print(f'Total: {total} handlers (expected 51 = 49 from 11 packages + 10 tdvs - 8 fs if skipped)')
"` -- fs may be skipped if tdfs4ds unavailable, that is acceptable

All checks must pass with zero errors.
  </verify>
  <done>
tdvs/__init__.py has __all__ with 16 entries. All 21 truly unused imports removed. 3 side-effect imports in app.py annotated with # noqa: F401. utils/__init__.py unused Optional removed. ruff check --select F401 reports zero violations across all modified files. Handler discovery unchanged (51 handlers across 12 packages, or 43 if fs skipped).
  </done>
</task>

</tasks>

<verification>
After the task is complete, confirm:

1. `ruff check --select F401` on all 14 modified files reports zero violations
2. All 12 tool packages with `__init__.py` re-exports have `__all__`
3. All handler counts unchanged from Phase 4 verified state (49 handlers + 1 class across 11 packages, plus 10 tdvs handlers)
4. The 3 `# noqa: F401` annotations in app.py correctly cover the side-effect imports
5. No functional behavior changed -- only dead imports removed
</verification>

<success_criteria>
- tdvs/__init__.py: `__all__` added with 16 entries
- 21 truly unused imports removed across 12 source files
- 3 side-effect imports annotated with `# noqa: F401` in app.py
- `ruff check --select F401` clean on all 14 modified files
- Handler discovery unchanged across all 12 tool packages
- Zero functional regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-ruff-enforcement/05-01-SUMMARY.md`
</output>
